# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master-2

pool:
  vmImage: ubuntu-latest

variables:
- name: VCPKG_BINARY_SOURCES
  value: 'clear;nuget,https://pkgs.dev.azure.com/natecheadle/IgnosiGameEngine/_packaging/VCPKG_CACHE/nuget/v3/index.json,readwrite'

- name: GTEST_OUTPUT
  value: 'xml:$(System.DefaultWorkingDirectory)/TEST-REPORT.xml'

steps:
- script: sudo apt-get install ninja-build
  displayName: "Install Ninja"

- task: NuGetAuthenticate@1

- task: CMake@1
  displayName: "Configure All"
  inputs:
    workingDirectory: '.' 
    cmakeArgs: -DCMAKE_TOOLCHAIN_FILE=$(VCPKG_INSTALLATION_ROOT)/scripts/buildsystems/vcpkg.cmake -B$(Build.BinariesDirectory) -GNinja -DVCPKG_INSTALL_OPTIONS="--debug"

- task: CMake@1
  displayName: "Build All"
  inputs:
    workingDirectory: '.' 
    cmakeArgs: --build $(Build.BinariesDirectory) 
    
- script: $(Build.BinariesDirectory)/Test/Ignosi.Test
  displayName: "Run Unit Tests"

- task: PublishTestResults@2
  displayName: "Publish Test Results"
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '**/TEST-*.xml' 
